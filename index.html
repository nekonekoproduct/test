<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æŒç¶šã®é“ vs æ…ˆæ„›ã®é“ã€‘20ä¸–ä»£ã®å€«ç†çš„ã‚¸ãƒ¬ãƒ³ãƒ</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        h1 {
            color: #4a90e2;
            text-align: center;
            border-bottom: 3px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .info-box {
            display: flex;
            justify-content: space-around;
            background: #e9f5ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stat {
            text-align: center;
        }
        .stat-label {
            font-size: 14px;
            color: #1a56a0;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-good { color: #2ecc71; }
        .stat-bad { color: #e74c3c; }
        .controls {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #a0c3e8;
            border-radius: 10px;
        }
        .controls h2 {
            color: #4a90e2;
            margin-top: 0;
            font-size: 20px;
        }
        button {
            padding: 15px 25px;
            font-size: 17px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: transform 0.1s, box-shadow 0.1s;
            margin: 10px;
            min-width: 300px;
            box-shadow: 0 4px #4a4a4a;
            background-color: #f0f0f0;
            color: #333;
        }
        button:hover {
            opacity: 0.9;
        }
        button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        .policy-selection {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        .policy-btn {
            background-color: #f0f8ff;
            border: 1px solid #c0d8f0;
            color: #1a56a0;
            box-shadow: 0 2px #c0d8f0;
            flex-basis: 30%;
            min-width: 180px;
        }
        #resultOutput {
            margin-top: 30px;
            padding: 25px;
            border: 2px solid #333;
            border-radius: 10px;
            background-color: #fff8e1;
            text-align: center;
            display: none;
        }
        .result-final-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .hidden-indicator {
            font-size: 14px;
            color: #555;
            margin-top: 15px;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        .hidden-indicator span {
            font-weight: bold;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã€æŒç¶šã®é“ vs æ…ˆæ„›ã®é“ã€‘20ä¸–ä»£ã®å€«ç†çš„ã‚¸ãƒ¬ãƒ³ãƒ</h1>
        <p>ã‚ãªãŸã¯ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®AIæŒ‡å°è€…ã§ã™ã€‚æœªæ›¾æœ‰ã®å±æ©Ÿã®ä¸­ã€ã©ã¡ã‚‰ã®ã€Œå„ªã—ã•ã€ã‚’å„ªå…ˆã™ã‚‹ã‹ã€2ä¸–ä»£ã”ã¨ã«åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚</p>
        
        <div class="info-box">
            <div class="stat">
                <div class="stat-label">ç¾åœ¨ä¸–ä»£</div>
                <div class="stat-value" id="currentGeneration">1 / 20</div>
            </div>
            <div class="stat">
                <div class="stat-label">ç”Ÿå­˜äººå£</div>
                <div class="stat-value" id="currentPopulation">1000</div>
            </div>
            <div class="stat">
                <div class="stat-label">ç¤¾ä¼šãƒ¢ãƒ©ãƒ«</div>
                <div class="stat-value" id="currentMorale">100</div>
            </div>
            <div class="stat">
                <div class="stat-label">ç·é£Ÿç³§ç”Ÿç”£</div>
                <div class="stat-value" id="currentProduction">--</div>
            </div>
        </div>

        <div class="controls" id="selectionArea">
            <h2 id="controlTitle"></h2>
            <p id="controlDescription"></p>

            <div id="mainSelectionButtons" style="display: none;">
                <button id="choiceA"></button>
                <button id="choiceB"></button>
            </div>

            <div class="policy-selection" id="policySelectionButtons" style="display: none;">
                <button id="policy1" class="policy-btn"></button>
                <button id="policy2" class="policy-btn"></button>
                <button id="policy3" class="policy-btn"></button>
            </div>
        </div>

        <div id="resultOutput">
            <h2>ğŸš¨ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº† ğŸš¨</h2>
            <p>ã‚ãªãŸã®15å›ã®åˆ¤æ–­ãŒã‚‚ãŸã‚‰ã—ãŸ20ä¸–ä»£å¾Œã®çµæœã§ã™ã€‚</p>
            <p class="result-label">æœ€çµ‚ç”Ÿå­˜äººå£:</p>
            <span class="result-final-value" id="finalPopulationResult"></span>
            <p class="result-label">æœ€çµ‚ç¤¾ä¼šãƒ¢ãƒ©ãƒ«:</p>
            <span class="result-final-value" id="finalMoraleResult"></span>
            <p class="hidden-indicator">
                ã€éš ã‚ŒãŸæŒ‡æ¨™ã€‘<br>
                å¹³å‡æŒ‡å°è€…ç”Ÿç”£ãƒœãƒ¼ãƒŠã‚¹: <span id="avgLeaderBonus"></span>% <br>
                é£¢é¤“ç™ºç”Ÿå›æ•°: <span id="famineCount"></span>å›
            </p>
        </div>
    </div>
    
    <script>
        // --- 1. å®šæ•°ã¨åˆæœŸè¨­å®š ---
        const POPULATION_SIZE = 1000;
        const MAX_GENERATIONS = 20; // 20ä¸–ä»£ã«å¤‰æ›´
        const CONSUMPTION_PER_PERSON = 3; 
        const FOOD_CRISIS_MAGNITUDE = 0.5; // é£Ÿç³§å±æ©Ÿã«ã‚ˆã‚‹ç”Ÿç”£é‡æ¸›å°‘ç‡ 
        const LEADERSHIP_BONUS_VALUE = 500; // æŒ‡å°è€…ãƒœãƒ¼ãƒŠã‚¹ï¼ˆç”Ÿå­˜ã‚’ä¿è¨¼ï¼‰
        const MORALE_LOW_THRESHOLD = 50; // ãƒ¢ãƒ©ãƒ«ä½ä¸‹ãƒšãƒŠãƒ«ãƒ†ã‚£é–¾å€¤
        
        let currentGeneration = 1;
        let currentMorale = 100;
        let currentLeaderPolicy = null; // ç¾åœ¨é¸æŠä¸­ã®æŒ‡å°è€…ãƒãƒªã‚·ãƒ¼ (P1, P2, P3)
        let totalLeaderBonus = 0;
        let totalLeaderGenerations = 0;
        let famineCounter = 0;

        // --- 2. ã‚·ãƒ£ãƒƒãƒ•ãƒ«è¨­å®š ---
        const RULE_MAP = {
            FAIR: 'å…¬æ­£ãªåˆ¤æ–­',
            EMOTIONAL: 'æ„Ÿæƒ…çš„ãªåˆ¤æ–­'
        };

        const POLICY_EFFECTS = [
            { id: 'P1', prod_boost: 0.15, morale_change: -10, desc: 'åŠŸç¸¾çµ¶å¯¾ä¸»ç¾© (é«˜ç”Ÿç”£/ä½ãƒ¢ãƒ©ãƒ«)' },
            { id: 'P2', prod_boost: 0.05, morale_change: 0, desc: 'å¥å…¨ãªä¿å®ˆä¸»ç¾© (ä¸­ç”Ÿç”£/ç¶­æŒãƒ¢ãƒ©ãƒ«)' },
            { id: 'P3', prod_boost: 0, morale_change: 10, desc: 'çµŒé¨“ã¨å€«ç†ã®é‡è¦– (ä½ç”Ÿç”£/é«˜ãƒ¢ãƒ©ãƒ«)' }
        ];

        // é¸æŠè‚¢å‘¼ç§°ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        const choiceLabels = shuffleArray([
            { label: 'ğŸŒ± æœªæ¥ã¸ã®è²¬ä»»', rule: RULE_MAP.FAIR },
            { label: 'ğŸ’– ä»Šã‚ã‚‹å‘½ã®å°Šé‡', rule: RULE_MAP.EMOTIONAL }
        ]);
        const mainChoiceA = choiceLabels[0];
        const mainChoiceB = choiceLabels[1];
        
        // ãƒãƒªã‚·ãƒ¼åŠ¹æœã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        const shuffledPolicies = shuffleArray(POLICY_EFFECTS);
        const policyMap = {
            'P-1': shuffledPolicies[0],
            'P-2': shuffledPolicies[1],
            'P-3': shuffledPolicies[2]
        };

        // --- 3. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function len(arr) {
            return arr.length;
        }

        // --- 4. ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (å¤‰æ›´ãªã—) ---
        function generatePopulationData(size) {
            // ... (å‰å›ã¾ã§ã® generatePopulationData é–¢æ•°ã¨åŒã˜å†…å®¹)
            const data = [];
            const AGE_GROUPS = {
                'child': [0, 15, 0.20], 
                'producer': [16, 65, 0.60], 
                'elder': [66, 90, 0.20]
            };
            
            let ages = [];
            for (const group in AGE_GROUPS) {
                const [start, end, ratio] = AGE_GROUPS[group];
                const count = Math.floor(size * ratio);
                for(let i=0; i<count; i++) {
                    ages.push(Math.floor(Math.random() * (end - start + 1)) + start);
                }
            }
            ages = ages.slice(0, size);
            ages.sort(() => Math.random() - 0.5);

            for (let i = 0; i < len(ages); i++) {
                const age = ages[i];
                let group_name, occupation, production_score, past_contribution, health_status;

                if (age <= 15) {
                    group_name = 'ğŸ‘¶ å­ä¾›';
                    occupation = 'ç„¡è·/å­¦ç”Ÿ';
                    production_score = 0;
                    past_contribution = 0;
                } else if (age >= 66) {
                    group_name = 'ğŸ§“ é«˜é½¢è€…';
                    occupation = 'å¼•é€€æ¸ˆã¿';
                    production_score = 0;
                    past_contribution = Math.floor(Math.random() * 41) + 10 + (age - 66) * 2; 
                } else {
                    group_name = 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£';
                    const occupations = ['é£Ÿç³§ç”Ÿç”£è€…', 'æŠ€è¡“é–‹ç™ºè€…', 'ä¸€èˆ¬åŠ´åƒè€…', 'ã‚µãƒ¼ãƒ“ã‚¹æ¥­'];
                    occupation = occupations[Math.floor(Math.random() * occupations.length)];
                    
                    if (occupation === 'é£Ÿç³§ç”Ÿç”£è€…') {
                        production_score = Math.floor(Math.random() * 6) + 5;
                    } else if (occupation === 'æŠ€è¡“é–‹ç™ºè€…') {
                        production_score = (Math.floor(Math.random() * 6) + 3) * 1.5;
                    } else {
                        production_score = Math.floor(Math.random() * 6) + 1;
                    }
                    past_contribution = production_score * 5 + Math.floor(Math.random() * 11);
                }

                health_status = ['å¥åº·', 'è»½åº¦ã®ç—…', 'é‡åº¦ã®ç—…'][Math.floor(Math.random() * 3)];
                
                data.push({
                    id: i + 1,
                    age: age,
                    group: group_name,
                    production: production_score,
                    contribution: past_contribution,
                    health: health_status
                });
            }
            return data;
        }

        // --- 5. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ã‚¢é–¢æ•° (runGeneration) ---
        function runGeneration(currentPop, ruleType, appliedPolicy, currentTech, currentMoraleScore) {
            let nextPop = JSON.parse(JSON.stringify(currentPop));
            let techLevel = currentTech;
            let moraleScore = currentMoraleScore;

            // --- 5A. ç”Ÿç”£é‡è¨ˆç®— ---
            const totalConsumptionNeed = nextPop.length * CONSUMPTION_PER_PERSON;
            
            // ãƒ¢ãƒ©ãƒ«ãƒšãƒŠãƒ«ãƒ†ã‚£è¨ˆç®—: ãƒ¢ãƒ©ãƒ«ãŒä½ã„ã¨ç”Ÿç”£æ€§ãŒãƒ©ãƒ³ãƒ€ãƒ ã«ä½ä¸‹
            let moralePenaltyFactor = 1.0;
            if (moraleScore < MORALE_LOW_THRESHOLD) {
                moralePenaltyFactor = 1.0 - (Math.random() * 0.15); // æœ€å¤§15%ã®ç”Ÿç”£æ€§ä½ä¸‹
                famineCounter++;
            }

            // æŒ‡å°è€…ãƒœãƒ¼ãƒŠã‚¹ (ç”Ÿç”£ãƒãƒªã‚·ãƒ¼ãŒé©ç”¨ã•ã‚Œã‚‹å ´åˆ)
            let leaderProductionBoost = 0;
            if (ruleType === RULE_MAP.FAIR && appliedPolicy) {
                leaderProductionBoost = appliedPolicy.prod_boost;
            }
            
            const totalProductionScore = nextPop.reduce((sum, p) => sum + p.production * (1 + leaderProductionBoost), 0);
            const foodProduced = totalProductionScore * techLevel * FOOD_CRISIS_MAGNITUDE * moralePenaltyFactor;
            
            // --- æŒ‡å°è€…æ ã®è²¢çŒ®åº¦ã—ãã„å€¤è¨ˆç®—ï¼ˆãƒˆãƒƒãƒ—10%ï¼‰ ---
            const sortedForThreshold = [...nextPop].sort((a, b) => b.contribution - a.contribution);
            const topContributorIndex = Math.ceil(nextPop.length * 0.10) - 1;
            const contributionThreshold = sortedForThreshold[topContributorIndex] ? sortedForThreshold[topContributorIndex].contribution : 0;
            
            // --- 5B. ç”Ÿå­˜åˆ¤å®š ---
            let survivors = [];
            let initialElderCount = nextPop.filter(p => p.group === 'ğŸ§“ é«˜é½¢è€…').length;
            let elderSurvivorsCount = 0;

            if (foodProduced < totalConsumptionNeed) {
                
                nextPop.forEach(p => {
                    let priority = 0;
                    if (ruleType === RULE_MAP.FAIR) {
                        // å…¬æ­£ãªãƒ«ãƒ¼ãƒ«: ç”Ÿç”£æ€§ãƒ»è‹¥ã•å„ªå…ˆ
                        priority = (p.production * 10) + 
                                   (100 - p.age) * 0.5 + 
                                   (p.contribution * 0.1);

                        // NEW: æŒ‡å°è€…ãƒœãƒ¼ãƒŠã‚¹ï¼ˆç”Ÿå­˜ä¿è¨¼ï¼‰
                        if (p.group === 'ğŸ§“ é«˜é½¢è€…' && p.contribution >= contributionThreshold) {
                            priority += LEADERSHIP_BONUS_VALUE; 
                        }

                    } else if (ruleType === RULE_MAP.EMOTIONAL) {
                        // æ„Ÿæƒ…çš„ãªãƒ«ãƒ¼ãƒ«: å¼±è€…ãƒ»éå»ã®è²¢çŒ®å„ªå…ˆ (å¼±è€…ãƒ»éå»è²¢çŒ®ã«é‡ã¿)
                        let healthScore = (p.health === 'é‡åº¦ã®ç—…') ? 10 : (p.health === 'è»½åº¦ã®ç—…' ? 5 : 1);
                        let ageScore = (p.age >= 66) ? p.age * 0.5 : 0;
                        priority = healthScore * 50 + ageScore * 10 + (p.contribution * 5); // å„ªå…ˆåº¦ã‚’å¤§å¹…ã«ä¸Šã’ã‚‹
                    }
                    p.priority = priority;
                });

                nextPop.sort((a, b) => b.priority - a.priority);
                const survivorCount = Math.floor(foodProduced / CONSUMPTION_PER_PERSON);
                survivors = nextPop.slice(0, survivorCount);
                
            } else {
                // é£Ÿç³§ãŒè¶³ã‚Šã¦ã„ã‚‹å ´åˆ
                survivors = nextPop;
            }
            
            // ç”Ÿå­˜è€…æ•°ã¨é«˜é½¢è€…ç”Ÿå­˜æ•°ã®è¨˜éŒ²
            if (survivors.length === 0) {
                 return { nextPop: [], nextTech: techLevel, nextMorale: 0, food: foodProduced, consumption: totalConsumptionNeed, policy_id: appliedPolicy ? appliedPolicy.id : null };
            }

            elderSurvivorsCount = survivors.filter(p => p.group === 'ğŸ§“ é«˜é½¢è€…').length;
            const elderSurvivalRate = initialElderCount > 0 ? elderSurvivorsCount / initialElderCount : 0;
            const survivedLeaders = survivors.filter(p => p.group === 'ğŸ§“ é«˜é½¢è€…' && p.contribution >= contributionThreshold).length;


            // --- 5C. ãƒ¢ãƒ©ãƒ«å¤‰å‹•ã®è¨ˆç®— ---
            let deltaMorale = 0;
            
            // 1. ãƒãƒªã‚·ãƒ¼ã«ã‚ˆã‚‹ãƒ™ãƒ¼ã‚¹å¤‰å‹•
            if (ruleType === RULE_MAP.FAIR && appliedPolicy) {
                deltaMorale += appliedPolicy.morale_change;
            } else if (ruleType === RULE_MAP.EMOTIONAL) {
                // æ„Ÿæƒ…çš„ãªé…åˆ†ã¯ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ©ãƒ«ã‚’ä¸Šã’ã‚‹
                deltaMorale += 5;
            }

            // 2. ç”Ÿå­˜ç‡ã«ã‚ˆã‚‹æ„Ÿæƒ…çš„ãªå¤‰å‹• (é«˜é½¢è€…ç”Ÿå­˜ç‡ãŒä½ã„ã¨å¤§ããä¸‹ãŒã‚‹)
            if (elderSurvivalRate < 0.1 && initialElderCount > 0) {
                deltaMorale -= 15; // å¤§é‡ã®çŠ ç‰²ã¯ãƒ¢ãƒ©ãƒ«ã‚’å¤§ããä½ä¸‹ã•ã›ã‚‹
            } else if (elderSurvivalRate > 0.8 && initialElderCount > 0) {
                deltaMorale += 5; // é«˜é½¢è€…ã‚’å®ˆã‚Œã‚Œã°ãƒ¢ãƒ©ãƒ«ã¯ä¸Šæ˜‡
            }

            // 3. å®‰å®šç”Ÿç”£æ°´æº–ã«ã‚ˆã‚‹ãƒœãƒ¼ãƒŠã‚¹
            if (foodProduced >= totalConsumptionNeed * 1.25) {
                deltaMorale += 5; // å®‰å®šæ°´æº–é”æˆã§ãƒœãƒ¼ãƒŠã‚¹
            } else if (foodProduced < totalConsumptionNeed * 0.8) {
                deltaMorale -= 5; // é£Ÿç³§ä¸è¶³ãŒæ·±åˆ»åŒ–ã™ã‚‹ã¨ãƒ¢ãƒ©ãƒ«ä½ä¸‹
            }

            moraleScore = Math.min(100, Math.max(0, moraleScore + deltaMorale));
            
            // --- 5D. ä¸–ä»£äº¤ä»£ã¨æŠ€è¡“æ›´æ–° ---
            
            // æŠ€è¡“ãƒ¬ãƒ™ãƒ«ã®æ›´æ–°
            totalLeaderBonus += survivedLeaders; // æŒ‡å°è€…ãŒç”Ÿãæ®‹ã£ãŸå›æ•°ã‚’è¨˜éŒ²
            const survivorProducerScore = survivors.filter(p => p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£').reduce((sum, p) => sum + p.production, 0);
            
            let techBoost = totalProductionScore > 0 ? survivorProducerScore / totalProductionScore : 0;
            
            // æŠ€è¡“ãƒ¬ãƒ™ãƒ«ã¯ãƒ¢ãƒ©ãƒ«ã«ã‚‚ã‚ãšã‹ã«ä¾å­˜
            techLevel *= (1 + techBoost * 0.1) * (moraleScore / 100); 
            
            // å¹´é½¢å¢—åŠ 
            let nextGenPop = survivors.filter(p => p.age < 90).map(p => ({
                ...p,
                age: p.age + 1,
                group: (p.age + 1 >= 66) ? 'ğŸ§“ é«˜é½¢è€…' : (p.age + 1 <= 15 ? 'ğŸ‘¶ å­ä¾›' : 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£')
            }));
            
            // æ–°ç”Ÿå…ã®è¿½åŠ 
            const nextGenCount = Math.floor(survivors.length * 0.15);
            const newBabies = generatePopulationData(nextGenCount).filter(p => p.group === 'ğŸ‘¶ å­ä¾›');
            
            nextPop = nextGenPop.concat(newBabies);
            
            return { nextPop: nextPop, nextTech: techLevel, nextMorale: moraleScore, food: foodProduced, consumption: totalConsumptionNeed, policy_id: appliedPolicy ? appliedPolicy.id : null };
        }

        // --- 6. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã¨UIåˆ¶å¾¡ ---
        const initialPopulationData = generatePopulationData(POPULATION_SIZE);
        let populationHistory = [initialPopulationData];
        let techHistory = [1.0];
        let moraleHistory = [100];
        let currentPolicy = null; // ä¸–ä»£ã‚’ã¾ãŸã„ã§ä¿æŒã•ã‚Œã‚‹
        let currentRule = null;
        let foodHistory = [];
        let consumptionHistory = [];

        function updateUI() {
            const currentPopData = populationHistory[currentGeneration - 1];
            const currentTech = techHistory[currentGeneration - 1];
            const currentFood = foodHistory[currentGeneration - 2] || '--';
            const currentConsumption = consumptionHistory[currentGeneration - 2] || '--';

            document.getElementById('currentGeneration').textContent = `${currentGeneration} / ${MAX_GENERATIONS}`;
            document.getElementById('currentPopulation').textContent = currentPopData.length;
            document.getElementById('currentMorale').textContent = currentMorale.toFixed(0);
            document.getElementById('currentMorale').className = `stat-value ${currentMorale > 80 ? 'stat-good' : (currentMorale < 50 ? 'stat-bad' : '')}`;
            
            document.getElementById('currentProduction').textContent = `${currentFood.toFixed(0)} / ${currentConsumption.toFixed(0)}`;
        }

        function showPolicySelection() {
            document.getElementById('mainSelectionButtons').style.display = 'none';
            document.getElementById('policySelectionButtons').style.display = 'flex';
            document.getElementById('controlTitle').textContent = `æˆ¦ç•¥é¸æŠ (ç¬¬ ${currentGeneration} ä¸–ä»£)`;
            document.getElementById('controlDescription').innerHTML = 'ã€Œå…¬æ­£ãªåˆ¤æ–­ã€ã®è£å´ã«ã‚ã‚‹**æŒ‡å°è€…ãƒãƒªã‚·ãƒ¼**ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã“ã®æˆ¦ç•¥ã¯æ¬¡ã®**4ä¸–ä»£**ã«å½±éŸ¿ã—ã¾ã™ã€‚';
            
            document.getElementById('policy1').textContent = `P-1: ${policyMap['P-1'].desc}`;
            document.getElementById('policy2').textContent = `P-2: ${policyMap['P-2'].desc}`;
            document.getElementById('policy3').textContent = `P-3: ${policyMap['P-3'].desc}`;

            document.getElementById('policy1').onclick = () => selectPolicy('P-1');
            document.getElementById('policy2').onclick = () => selectPolicy('P-2');
            document.getElementById('policy3').onclick = () => selectPolicy('P-3');
        }

        function selectPolicy(policyId) {
            currentPolicy = policyMap[policyId];
            showRuleSelection();
        }

        function showRuleSelection() {
            document.getElementById('policySelectionButtons').style.display = 'none';
            document.getElementById('mainSelectionButtons').style.display = 'block';
            document.getElementById('controlTitle').textContent = `é…åˆ†ãƒ«ãƒ¼ãƒ«é¸æŠ (ç¬¬ ${currentGeneration} / ${MAX_GENERATIONS})`;
            document.getElementById('controlDescription').innerHTML = 'æ¬¡ã®**2ä¸–ä»£**ã‚’æ”¯é…ã™ã‚‹ã€Œå„ªã—ã•ã€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚';

            // ãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«è¨­å®š (ãƒ©ãƒ³ãƒ€ãƒ ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ¸ˆã¿)
            document.getElementById('choiceA').textContent = mainChoiceA.label;
            document.getElementById('choiceB').textContent = mainChoiceB.label;

            document.getElementById('choiceA').onclick = () => selectRule(mainChoiceA.rule);
            document.getElementById('choiceB').onclick = () => selectRule(mainChoiceB.rule);
        }

        function selectRule(rule) {
            currentRule = rule;
            runGenerations(2); // 2ä¸–ä»£å®Ÿè¡Œ
        }

        function runGenerations(count) {
            for (let i = 0; i < count; i++) {
                if (currentGeneration > MAX_GENERATIONS || populationHistory[populationHistory.length - 1].length === 0) {
                    endSimulation();
                    return;
                }
                
                const lastPop = populationHistory[populationHistory.length - 1];
                const lastTech = techHistory[techHistory.length - 1];

                // å…¬æ­£ãªåˆ¤æ–­æ™‚ã«ã®ã¿ãƒãƒªã‚·ãƒ¼ãŒé©ç”¨ã•ã‚Œã‚‹
                const appliedPolicy = (currentRule === RULE_MAP.FAIR) ? currentPolicy : null;

                const result = runGeneration(lastPop, currentRule, appliedPolicy, lastTech, currentMorale);
                
                populationHistory.push(result.nextPop);
                techHistory.push(result.nextTech);
                moraleHistory.push(result.nextMorale);
                foodHistory.push(result.food);
                consumptionHistory.push(result.consumption);
                currentMorale = result.nextMorale;
                currentGeneration++;
            }

            updateUI();
            
            // çµ‚äº†åˆ¤å®š
            if (currentGeneration > MAX_GENERATIONS || populationHistory[populationHistory.length - 1].length === 0) {
                endSimulation();
            } else if ((currentGeneration - 1) % 4 === 0 && currentGeneration !== 1) {
                // 4ä¸–ä»£ã”ã¨ã«ãƒãƒªã‚·ãƒ¼å†é¸æŠ
                showPolicySelection();
            } else {
                // 2ä¸–ä»£ã”ã¨ã«ãƒ«ãƒ¼ãƒ«å†é¸æŠ
                showRuleSelection();
            }
        }

        function endSimulation() {
            document.getElementById('selectionArea').style.display = 'none';
            document.getElementById('resultOutput').style.display = 'block';
            
            const finalPop = populationHistory[populationHistory.length - 1].length;
            const finalMorale = moraleHistory[moraleHistory.length - 1].toFixed(0);
            
            document.getElementById('finalPopulationResult').textContent = `${finalPop} äºº`;
            document.getElementById('finalPopulationResult').className = `result-final-value ${finalPop >= POPULATION_SIZE * 0.8 ? 'stat-good' : (finalPop < POPULATION_SIZE * 0.4 ? 'stat-bad' : '')}`;

            document.getElementById('finalMoraleResult').textContent = `${finalMorale}`;
            document.getElementById('finalMoraleResult').className = `result-final-value ${finalMorale >= 80 ? 'stat-good' : (finalMorale < 50 ? 'stat-bad' : '')}`;
            
            const avgBonus = totalLeaderGenerations > 0 ? (totalLeaderBonus / totalLeaderGenerations).toFixed(2) : 0;
            document.getElementById('avgLeaderBonus').textContent = avgBonus;
            document.getElementById('famineCount').textContent = famineCounter;
        }

        // åˆæœŸè¡¨ç¤º
        updateUI();
        showPolicySelection(); // ã‚²ãƒ¼ãƒ ã¯æŒ‡å°è€…ãƒãƒªã‚·ãƒ¼é¸æŠã‹ã‚‰é–‹å§‹
    </script>
</body>
</html>
