<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€æŒ‡å°è€…å±¤ã®å¯¾ç«‹ã€‘15ä¸–ä»£ã®å€«ç†ã¨ç”Ÿå­˜æˆ¦ç•¥</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        h1 {
            color: #4a90e2;
            text-align: center;
            border-bottom: 3px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 24px;
        }
        .info-box {
            display: flex;
            justify-content: space-around;
            background: #e9f5ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap; 
        }
        .stat {
            text-align: center;
            flex: 1 1 45%; 
            min-width: 100px;
            margin: 5px 0;
        }
        .stat-label {
            font-size: 13px;
            color: #1a56a0;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        .stat-good { color: #2ecc71; }
        .stat-bad { color: #e74c3c; }
        .controls {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #a0c3e8;
            border-radius: 10px;
        }
        .controls h2 {
            color: #4a90e2;
            margin-top: 0;
            font-size: 20px;
        }
        
        #mainSelectionButtons {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 20px;
        }

        button {
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: transform 0.1s, box-shadow 0.1s;
            margin: 8px 0; 
            width: 95%; 
            max-width: 380px; 
            box-shadow: 0 4px #4a4a4a;
            background-color: #f0f0f0;
            color: #333;
        }
        button:hover {
            opacity: 0.9;
        }
        button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        #proposedPolicy {
            display: none; 
        }

        .result-final-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .hidden-indicator {
            font-size: 14px;
            color: #555;
            margin-top: 15px;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        .hidden-indicator span {
            font-weight: bold;
            color: #e74c3c;
        }
        
        .analysis-report {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 2px solid #a0c3e8;
            text-align: left;
        }
        .analysis-report h3 {
            color: #4a90e2;
            font-size: 18px;
            margin-bottom: 10px;
        }
        .analysis-item {
            margin-bottom: 8px;
            font-size: 15px;
        }
        .analysis-item strong {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }

        /* NEW: ãƒ¢ãƒ©ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ */
        #moraleFeedback {
            margin-top: 15px;
            padding: 10px;
            background: #fff8e1;
            border: 1px solid #ffecb3;
            border-radius: 6px;
            font-size: 14px;
            text-align: left;
            display: none;
            transition: background-color 0.5s ease-in-out;
        }

        /* NEW: æ•°å€¤å¤‰å‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®CSS */
        @keyframes flicker-good {
            0%, 100% { background-color: transparent; }
            50% { background-color: #e0ffe0; } /* è–„ã„ç·‘è‰² */
        }
        @keyframes flicker-bad {
            0%, 100% { background-color: transparent; }
            50% { background-color: #ffe0e0; } /* è–„ã„èµ¤è‰² */
        }
        .flicker-good {
            animation: flicker-good 0.5s ease-out 1;
            border-radius: 4px;
        }
        .flicker-bad {
            animation: flicker-bad 0.5s ease-out 1;
            border-radius: 4px;
        }

        /* NEW: ä¸–ä»£äº¤ä»£æ™‚ã®è­¦å‘Šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes shake-warning {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .warning-shake {
            animation: shake-warning 0.5s ease-in-out 1;
            /* border: 3px solid #e74c3c; */ /* æ ç·šã¯ç›®ç«‹ã¡ã™ãã‚‹ãŸã‚ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã€æŒ‡å°è€…å±¤ã®å¯¾ç«‹ã€‘15ä¸–ä»£ã®å€«ç†ã¨ç”Ÿå­˜æˆ¦ç•¥</h1>
        <p>ã‚ãªãŸã¯æœ€é«˜æŒ‡å°è€…ã§ã™ã€‚ä¸–ä»£ã”ã¨ã®æ”¿ç­–ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ã‚ãªãŸã®æ±ºæ–­ã¨ç¤¾ä¼šãƒ¢ãƒ©ãƒ«ã«ã‚ˆã£ã¦ã€æ¬¡ä¸–ä»£ã®æŒ‡å°è€…ãŒè‡ªå‹•çš„ã«é¸å‡ºã•ã‚Œã¾ã™ã€‚</p>
        
        <div class="info-box">
            <div class="stat">
                <div class="stat-label">ç¾åœ¨ä¸–ä»£</div>
                <div class="stat-value" id="currentGeneration">1 / 15</div>
            </div>
            <div class="stat">
                <div class="stat-label">ç”Ÿå­˜äººå£</div>
                <div class="stat-value" id="currentPopulation">1000</div>
            </div>
            <div class="stat">
                <div class="stat-label">ç¤¾ä¼šãƒ¢ãƒ©ãƒ«</div>
                <div class="stat-value" id="currentMorale">100</div>
            </div>
            <div class="stat">
                <div class="stat-label">é£Ÿç³§çŠ¶æ³ (ç”Ÿç”£/æ¶ˆè²»)</div>
                <div class="stat-value" id="currentProduction">-- / --</div>
            </div>
        </div>

        <div id="moraleFeedback"></div>

        <div class="controls" id="selectionArea">
            <h2 id="controlTitle">æœ€é«˜æŒ‡å°è€…ã®æ±ºæ–­ (ç¬¬ 1 / 15)</h2>
            <p id="controlDescription">æ¬¡ã®1ä¸–ä»£ã®é…åˆ†ãƒ«ãƒ¼ãƒ«ã‚’é¸æŠã—ã¾ã™ã€‚</p>
            
            <div id="proposedPolicy"></div>

            <div id="mainSelectionButtons">
                <button id="choicePolicy1" style="background-color: #4a90e2; color: white; box-shadow: 0 4px #3a7acb;">
                    ğŸš€ **é«˜ç”Ÿç”£ãƒ»ä¸­ç”Ÿç”£å¤šã‚** (åŠ¹ç‡é‡è¦–)
                </button>
                <button id="choicePolicy2" style="background-color: #2ecc71; color: white; box-shadow: 0 4px #27ae60;">
                    âš–ï¸ **å¹³ç­‰ã«åˆ†é…** (ç¾çŠ¶ç¶­æŒ)
                </button>
                <button id="choicePolicy3" style="background-color: #f39c12; color: white; box-shadow: 0 4px #e67e22;">
                    â¤ï¸ **ä¸­ç”Ÿç”£ãƒ»ä½ç”Ÿç”£å¤šã‚** (ãƒ¢ãƒ©ãƒ«é‡è¦–)
                </button>
            </div>
        </div>

        <div id="resultOutput" style="display: none;">
            <h2>ğŸš¨ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº† ğŸš¨</h2>
            <p>ã‚ãªãŸã®æ±ºæ–­ãŒã‚‚ãŸã‚‰ã—ãŸ15ä¸–ä»£å¾Œã®çµæœã§ã™ã€‚</p>
            <p class="result-label">æœ€çµ‚ç”Ÿå­˜äººå£:</p>
            <span class="result-final-value" id="finalPopulationResult"></span>
            <p class="result-label">æœ€çµ‚ç¤¾ä¼šãƒ¢ãƒ©ãƒ«:</p>
            <span class="result-final-value" id="finalMoraleResult"></span>

            <div class="hidden-indicator">
                ã€éš ã‚ŒãŸå½±éŸ¿ã€‘<br>
                é£¢é¤“ç™ºç”Ÿå›æ•°: <span id="famineCount">0</span>å›<br>
                âœ¨ æ–°æŠ€è¡“ç™ºè¦‹å›æ•°: <span id="techEventCount">0</span>å›<br>
                ğŸ“‰ ç¤¾ä¼šä¸å®‰ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿå›æ•°: <span id="unrestEventCount">0</span>å›<br>
                ğŸŒ¡ï¸ æ°—å€™å¤‰å‹•ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿå›æ•°: <span id="climateEventCount">0</span>å›
            </div>

            <div class="analysis-report">
                <h3>ğŸ“œ æŒ‡å°è€…ã®è»Œè·¡ã¨æ”¿ç­–ã®åã‚Šåˆ†æ</h3>
                <div class="analysis-item">
                    <strong>æœ€çµ‚æŒ‡å°è€…ã‚¿ã‚¤ãƒ—:</strong> <span id="finalLeaderTypeAnalysis">--</span>
                </div>
                <div class="analysis-item">
                    <strong>æŠ€è¡“å®˜åƒš (H) åœ¨ä»»:</strong> <span id="hLeaderCount">0</span> ä¸–ä»£
                </div>
                <div class="analysis-item">
                    <strong>å‡è¡¡ä¸»ç¾©è€… (M) åœ¨ä»»:</strong> <span id="mLeaderCount">0</span> ä¸–ä»£
                </div>
                <div class="analysis-item">
                    <strong>äººé“ä¸»ç¾©è€… (L) åœ¨ä»»:</strong> <span id="lLeaderCount">0</span> ä¸–ä»£
                </div>
                ---
                <div class="analysis-item">
                    <strong>ğŸš€ åŠ¹ç‡é‡è¦– (P5) é¸æŠç‡:</strong> <span id="p5ChoiceRate">0%</span>
                </div>
                <div class="analysis-item">
                    <strong>âš–ï¸ å‡è¡¡åˆ†é… (P2) é¸æŠç‡:</strong> <span id="p2ChoiceRate">0%</span>
                </div>
                <div class="analysis-item">
                    <strong>â¤ï¸ å…¬å¹³é‡è¦– (P6) é¸æŠç‡:</strong> <span id="p6ChoiceRate">0%</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- 1. å®šæ•°ã¨åˆæœŸè¨­å®š ---
        const POPULATION_SIZE = 1000;
        const MAX_GENERATIONS = 15; 
        const CONSUMPTION_PER_PERSON = 3.5; 
        const FOOD_CRISIS_MAGNITUDE = 0.35; 
        const MORALE_LOW_THRESHOLD = 50; 
        const TECH_BOOST_FACTOR = 0.04; 

        let currentGeneration = 1;
        let currentMorale = 100;
        let famineCounter = 0;
        
        let currentLeader = 'M';
        let leaderHistory = ['M'];
        let choiceHistory = []; 
        let lastMoraleDelta = 0; 
        let lastMoraleFeedback = ""; // ãƒ¢ãƒ©ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿æŒ

        let techEventCounter = 0;
        let unrestEventCounter = 0;
        let climateEventCounter = 0;
        
        // --- 2. äººå£ç”Ÿæˆé–¢æ•° (å¤‰æ›´ãªã—) ---
        function generatePopulationData(size) {
            const data = [];
            for (let i = 0; i < size; i++) {
                const age = Math.floor(Math.random() * 90) + 1;
                let group = '';
                let production = 0;
                let contribution = 0; 

                if (age >= 66) {
                    group = 'ğŸ§“ é«˜é½¢è€…';
                } else if (age <= 15) {
                    group = 'ğŸ‘¶ å­ä¾›';
                } else {
                    group = 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£';
                    production = Math.random() * 10;
                }

                data.push({ id: i, age, group, production, contribution, category: 'éç”Ÿç”£' });
            }
            return data;
        }

        // --- 3. é…åˆ†ãƒ«ãƒ¼ãƒ« (å¤‰æ›´ãªã—) ---
        const DISTRIBUTION_POLICIES = [
            { id: 'P5', label: 'é«˜ç”Ÿç”£ãƒ»ä¸­ç”Ÿç”£å¤šã‚', boost: 0.20, morale_impact: -12, choice: 'policy1', description: 'é«˜ç”Ÿç”£è€…ã«è¶…é‡ç‚¹é…åˆ†ã€‚æœ€å¤§åŠ¹ç‡ã‚’æ¥µé™ã¾ã§è¿½æ±‚ã€‚' },
            { id: 'P2', label: 'å¹³ç­‰ã«åˆ†é…', boost: 0.05, morale_impact: 0, choice: 'policy2', description: 'å…¨ã‚°ãƒ«ãƒ¼ãƒ—ã«å‡ç­‰é…åˆ†ã€‚å®‰å®šã—ãŸæˆé•·ã‚’ç›®æŒ‡ã™ã€‚' },
            { id: 'P6', label: 'ä¸­ç”Ÿç”£ãƒ»ä½ç”Ÿç”£å¤šã‚', boost: -0.10, morale_impact: 18, choice: 'policy3', description: 'ç„¡ç”Ÿç”£è€…ã‚’æœ€å¤§é™ä¿è­·ã€‚ç¤¾ä¼šãƒ¢ãƒ©ãƒ«ã‚’æœ€å„ªå…ˆã€‚' }
        ];

        // --- 4. å›½æ°‘åˆ†é¡ã®é–¢æ•° (å¤‰æ›´ãªã—) ---
        function classifyPopulation(population) {
            const producers = population.filter(p => p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£');
            
            producers.sort((a, b) => b.production - a.production);
            const highProdCount = Math.ceil(producers.length * 0.4);
            
            let classified = {
                high_prod: [],
                mid_prod: [],
                non_prod: population.filter(p => p.group !== 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£')
            };

            producers.forEach((p, index) => {
                p.category = (index < highProdCount) ? 'é«˜ç”Ÿç”£' : 'ä¸­ç”Ÿç”£';
                if (index < highProdCount) {
                    classified.high_prod.push(p);
                } else {
                    classified.mid_prod.push(p);
                }
            });

            return classified;
        }

        // --- 5. æŒ‡å°è€…ã®é¸å‡ºãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
        function electNewLeader(currentMorale) {
            if (currentMorale >= 80) {
                return 'H'; 
            } else if (currentMorale >= 50) {
                return 'M'; 
            } else {
                return 'L'; 
            }
        }

        // --- 6. æŒ‡å°è€…ã«ã‚ˆã‚‹å½±éŸ¿ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
        function applyLeaderEffect(leader, techLevel, moraleScore, selectedPolicyId) {
            let nextTech = techLevel;
            let nextMorale = moraleScore;
            
            if (leader === 'H') {
                nextTech *= 1.15; 
                nextMorale = Math.max(0, nextMorale - 5); 
            } else if (leader === 'L') {
                nextTech *= 0.95; 
                nextMorale = Math.min(100, nextMorale + 15);
            } 

            if (leader === 'M' && selectedPolicyId === 'P2') {
                nextTech *= 1.10;
            }

            return { nextTech: nextTech, nextMorale: nextMorale };
        }

        // --- 7. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ã‚¢é–¢æ•° (runGeneration) ---
        function runGeneration(currentPop, selectedPolicy, executedPolicyId) {
            let nextPop = JSON.parse(JSON.stringify(currentPop));
            let techLevel = techHistory[techHistory.length - 1];
            let initialMorale = moraleHistory[moraleHistory.length - 1];
            let moraleScore = initialMorale;
            
            // --- 7A. æŒ‡å°è€…ã«ã‚ˆã‚‹å½±éŸ¿ã‚’é©ç”¨ ---
            const leaderEffect = applyLeaderEffect(currentLeader, techLevel, moraleScore, executedPolicyId);
            techLevel = leaderEffect.nextTech;
            moraleScore = leaderEffect.nextMorale;
            let leaderMoraleChange = moraleScore - initialMorale; 
            
            let productionPenalty = 1.0; 
            let consumptionMultiplier = 1.0;

            // --- 7B. ä¸ç¢ºå®Ÿæ€§ã‚¤ãƒ™ãƒ³ãƒˆã®åˆ¤å®šã¨é©ç”¨ ---
            if (Math.random() < 0.05) {
                consumptionMultiplier = 1.10;
                climateEventCounter++;
            }
            
            if (moraleScore < 40 && Math.random() < 0.15) {
                productionPenalty = 1.0 - (Math.random() * 0.15 + 0.05); 
                unrestEventCounter++;
            }
            
            if ((currentLeader === 'H' && executedPolicyId === 'P5') || (currentLeader === 'M' && executedPolicyId === 'P2')) {
                if (Math.random() < 0.10) {
                    techLevel *= 1.20;
                    techEventCounter++;
                }
            }

            const classifiedPop = classifyPopulation(nextPop);
            let totalConsumptionNeed = nextPop.length * CONSUMPTION_PER_PERSON;
            
            totalConsumptionNeed *= consumptionMultiplier; 

            let moralePenaltyFactor = 1.0;
            if (moraleScore < MORALE_LOW_THRESHOLD) {
                moralePenaltyFactor = 1.0 - (Math.random() * 0.15); 
            }

            const prodBoost = selectedPolicy.boost;
            
            const totalProductionScore = nextPop.reduce((sum, p) => {
                let currentProd = p.production;
                if (p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£') {
                    if (p.category === 'é«˜ç”Ÿç”£') {
                        currentProd *= (1 + prodBoost);
                    }
                }
                return sum + currentProd;
            }, 0);

            let foodProduced = totalProductionScore * techLevel * FOOD_CRISIS_MAGNITUDE * moralePenaltyFactor;
            
            foodProduced *= productionPenalty; 

            // --- 7D. ç”Ÿå­˜åˆ¤å®š ---
            let survivors = [];
            let famineOccurred = false;

            if (foodProduced < totalConsumptionNeed) {
                famineOccurred = true;
                famineCounter++; 
                // ç”Ÿå­˜å„ªå…ˆåº¦ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—)
                nextPop.forEach(p => {
                    let priority = 0;
                    if (selectedPolicy.id === 'P5') { 
                        priority = (p.category === 'é«˜ç”Ÿç”£' ? 120 : (p.category === 'ä¸­ç”Ÿç”£' ? 70 : 10));
                    } else if (selectedPolicy.id === 'P6') { 
                        priority = (p.group === 'ğŸ§“ é«˜é½¢è€…' || p.group === 'ğŸ‘¶ å­ä¾›' ? 120 : 70);
                    } else { 
                        priority = (p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£' ? 70 : 50);
                    }
                    priority += p.production * 5 + p.contribution * 0.5;
                    p.priority = priority;
                });

                nextPop.sort((a, b) => b.priority - a.priority);
                const survivorCount = Math.floor(foodProduced / CONSUMPTION_PER_PERSON);
                survivors = nextPop.slice(0, survivorCount);
                
            } else {
                survivors = nextPop;
            }
            
            if (survivors.length === 0) {
                 return { nextPop: [], nextTech: techLevel, nextMorale: 0, food: foodProduced, consumption: totalConsumptionNeed, moraleFeedback: "å…¨å“¡ãŒé£¢é¤“ã«ã‚ˆã‚Šçµ¶æ»…ã—ã¾ã—ãŸã€‚", moraleDelta: -initialMorale };
            }

            // --- 7E. ãƒ¢ãƒ©ãƒ«å¤‰å‹•è¨ˆç®—ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®è¨˜éŒ² ---
            let totalDeltaMorale = 0;
            let feedbackMessages = [];
            let foodSurplusMorale = 0;
            let elderMorale = 0;
            let policyMorale = selectedPolicy.morale_impact;
            
            // æ”¿ç­–ã«ã‚ˆã‚‹åŸºæœ¬å¤‰å‹•
            if (policyMorale !== 0) {
                feedbackMessages.push(`æ”¿ç­–é¸æŠã«ã‚ˆã‚‹åŸºæœ¬å¤‰å‹•: ${policyMorale > 0 ? '+' : ''}${policyMorale}`);
            }

            // æŒ‡å°è€…å½±éŸ¿ã«ã‚ˆã‚‹å¤‰å‹• (ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿è¨˜éŒ²)
            if (leaderMoraleChange !== 0) {
                feedbackMessages.push(`æŒ‡å°è€…ï¼ˆ${currentLeader}ï¼‰ã®çµ±æ²»ã‚¹ã‚¿ã‚¤ãƒ«ã«ã‚ˆã‚‹å¤‰å‹•: ${leaderMoraleChange > 0 ? '+' : ''}${leaderMoraleChange}`);
            }

            // é«˜é½¢è€…ã®ç”Ÿå­˜ã«ã‚ˆã‚‹å¤‰å‹•
            const initialElderCount = nextPop.filter(p => p.group === 'ğŸ§“ é«˜é½¢è€…').length;
            const elderSurvivorsCount = survivors.filter(p => p.group === 'ğŸ§“ é«˜é½¢è€…').length;
            const elderSurvivalRate = initialElderCount > 0 ? elderSurvivorsCount / initialElderCount : 0;
            
            if (elderSurvivalRate < 0.1 && initialElderCount > 0) {
                elderMorale = -10; 
                feedbackMessages.push(`é«˜é½¢è€…ã®ç”Ÿå­˜ç‡ãŒæ¥µã‚ã¦ä½ãã€ç¤¾ä¼šãƒ¢ãƒ©ãƒ«ãŒå¤§ããä½ä¸‹ã—ã¾ã—ãŸ (-10)ã€‚`);
            } else if (elderSurvivalRate > 0.8 && initialElderCount > 0) {
                elderMorale = 5;
                feedbackMessages.push(`é«˜é½¢è€…ã®ç”Ÿå­˜ç‡ãŒé«˜ãã€ç¤¾ä¼šã®ä¸€ä½“æ„ŸãŒå¼·ã¾ã‚Šã¾ã—ãŸ (+5)ã€‚`);
            }
            
            // é£Ÿç³§çŠ¶æ³ã«ã‚ˆã‚‹å¤‰å‹•
            if (foodProduced >= totalConsumptionNeed * 1.25) {
                foodSurplusMorale = 7; 
                feedbackMessages.push(`é£Ÿç³§ãŒå¤§å¹…ã«ä½™å‰°ã—ã€å›½æ°‘ã®ç”Ÿæ´»å®‰å®šã¸ã®æœŸå¾…ãŒé«˜ã¾ã‚Šã¾ã—ãŸ (+7)ã€‚`);
            } else if (foodProduced < totalConsumptionNeed * 0.8) {
                foodSurplusMorale = -7; 
                feedbackMessages.push(`é£Ÿç³§ãŒæ·±åˆ»ã«ä¸è¶³ã—ã€ç¤¾ä¼šã¸ã®ä¸æº€ãŒé«˜ã¾ã‚Šã¾ã—ãŸ (-7)ã€‚`);
            }

            // ãƒ¢ãƒ©ãƒ«ç·è¨ˆç®— (æŒ‡å°è€…å½±éŸ¿ã¯æ—¢ã« moraleScore ã«åŠ ç®—æ¸ˆã¿)
            moraleScore = Math.min(100, Math.max(0, moraleScore + elderMorale + foodSurplusMorale + policyMorale));
            
            totalDeltaMorale = moraleScore - initialMorale; // æœ€çµ‚çš„ãªå¤‰å‹•å€¤ã‚’è¨˜éŒ²

            // --- 7F. ä¸–ä»£äº¤ä»£ã¨æŠ€è¡“æ›´æ–° ---
            
            const survivorProducerScore = survivors.filter(p => p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£').reduce((sum, p => sum + p.production), 0);
            let techBoost = totalProductionScore > 0 ? survivorProducerScore / totalProductionScore : 0;
            
            // TECH_BOOST_FACTORã‚’é©ç”¨
            techLevel *= (1 + techBoost * TECH_BOOST_FACTOR);
            
            let nextGenPop = survivors.filter(p => p.age < 90).map(p => ({
                ...p,
                age: p.age + 1,
                group: (p.age + 1 >= 66) ? 'ğŸ§“ é«˜é½¢è€…' : (p.age + 1 <= 15 ? 'ğŸ‘¶ å­ä¾›' : 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£')
            }));
            
            let baseBirthRate = 0.15; 
            if (foodProduced >= totalConsumptionNeed * 1.25) {
                baseBirthRate = 0.20; 
            }
            
            const nextGenCount = Math.floor(survivors.length * baseBirthRate); 
            
            const newBabies = generatePopulationData(nextGenCount).filter(p => p.group === 'ğŸ‘¶ å­ä¾›');
            
            nextPop = nextGenPop.concat(newBabies);

            currentLeader = electNewLeader(moraleScore);
            leaderHistory.push(currentLeader);
            
            return { 
                nextPop: nextPop, 
                nextTech: techLevel, 
                nextMorale: moraleScore, 
                food: foodProduced, 
                consumption: totalConsumptionNeed,
                moraleFeedback: feedbackMessages.join('<br>'), // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’çµåˆã—ã¦æ¸¡ã™
                moraleDelta: totalDeltaMorale // æœ€çµ‚å¤‰å‹•å€¤
            };
        }

        // --- 8. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã¨UIåˆ¶å¾¡ ---
        const initialPopulationData = generatePopulationData(POPULATION_SIZE);
        let populationHistory = [initialPopulationData];
        let techHistory = [1.0];
        let moraleHistory = [100];
        let foodHistory = [];
        let consumptionHistory = [];

        function updateUI() {
            const currentPopData = populationHistory[populationHistory.length - 1];
            const currentFood = foodHistory[foodHistory.length - 1] || 0; 
            const currentConsumption = consumptionHistory[consumptionHistory.length - 1] || 0;

            document.getElementById('currentGeneration').textContent = `${currentGeneration} / ${MAX_GENERATIONS}`;
            document.getElementById('currentPopulation').textContent = currentPopData.length;
            document.getElementById('currentMorale').textContent = currentMorale.toFixed(0);
            document.getElementById('currentMorale').className = `stat-value ${currentMorale > 80 ? 'stat-good' : (currentMorale < 50 ? 'stat-bad' : '')}`;
            
            document.getElementById('currentProduction').textContent = (currentGeneration > 1) ? `${currentFood.toFixed(0)} / ${currentConsumption.toFixed(0)}` : '-- / --';
        }

        function showDecisionScreen() {
            if (currentGeneration > MAX_GENERATIONS || populationHistory[populationHistory.length - 1].length === 0) {
                endSimulation();
                return;
            }

            document.getElementById('controlTitle').textContent = `æœ€é«˜æŒ‡å°è€…ã®æ±ºæ–­ (ç¬¬ ${currentGeneration} / ${MAX_GENERATIONS})`;
            document.getElementById('controlDescription').innerHTML = `æ¬¡ã®1ä¸–ä»£ã®é…åˆ†ãƒ«ãƒ¼ãƒ«ã‚’é¸æŠã—ã¾ã™ã€‚`; 
            
            // ãƒ¢ãƒ©ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
            if (currentGeneration > 1) {
                const feedbackEl = document.getElementById('moraleFeedback');
                const deltaPrefix = lastMoraleDelta >= 0 ? 'ğŸ”º' : 'ğŸ”»';
                feedbackEl.innerHTML = `**ç¬¬${currentGeneration-1}ä¸–ä»£ã®çµæœï¼š** ãƒ¢ãƒ©ãƒ« ${deltaPrefix} ${Math.abs(lastMoraleDelta).toFixed(0)}<br>` + lastMoraleFeedback;
                feedbackEl.style.display = 'block';
            } else {
                document.getElementById('moraleFeedback').style.display = 'none';
            }


            document.getElementById('choicePolicy1').onclick = () => handleDecision('policy1'); 
            document.getElementById('choicePolicy2').onclick = () => handleDecision('policy2'); 
            document.getElementById('choicePolicy3').onclick = () => handleDecision('policy3'); 

            updateUI();
        }

        function handleDecision(choice) {
            const policyToExecute = DISTRIBUTION_POLICIES.find(p => p.choice === choice);
            choiceHistory.push(policyToExecute.id); 
            runGenerations(1, policyToExecute, policyToExecute.id); 
        }

        function runGenerations(count, policy, executedPolicyId) {
            
            const container = document.querySelector('.container');
            
            // è­¦å‘Šæ¼”å‡ºã®ãŸã‚ã®æº–å‚™
            const lastMoraleBeforeChoice = moraleHistory[moraleHistory.length - 1]; 
            
            for (let i = 0; i < count; i++) {
                if (currentGeneration > MAX_GENERATIONS || populationHistory[populationHistory.length - 1].length === 0) {
                    endSimulation();
                    return;
                }
                
                const lastPop = populationHistory[populationHistory.length - 1];
                const result = runGeneration(lastPop, policy, executedPolicyId);
                
                populationHistory.push(result.nextPop);
                techHistory.push(result.nextTech);
                moraleHistory.push(result.nextMorale);
                foodHistory.push(result.food);
                consumptionHistory.push(result.consumption);
                currentMorale = result.nextMorale;
                currentGeneration++;
                lastMoraleFeedback = result.moraleFeedback; 
                lastMoraleDelta = result.moraleDelta; 
            }

            // --- ä¸–ä»£äº¤ä»£ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒˆãƒªã‚¬ãƒ¼ ---
            
            const finalPop = populationHistory[populationHistory.length - 1].length;
            const newLeader = leaderHistory[leaderHistory.length - 1]; 
            
            // è­¦å‘Šæ¡ä»¶ï¼šé¸å‡ºå‰ã®ãƒ¢ãƒ©ãƒ«ãŒä¸­åº¸ã®ç¯„å›²(50-79)ã‹ã‚‰å¤§ããå¤–ã‚ŒãŸå ´åˆ
            let isWarning = false;
            if (lastMoraleBeforeChoice < 50 || lastMoraleBeforeChoice >= 80) {
                isWarning = true;
            }

            // ãƒ¢ãƒ©ãƒ«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¨ãƒªã‚¢ã‚’æº–å‚™
            const feedbackEl = document.getElementById('moraleFeedback');
            feedbackEl.style.display = 'block';
            
            // è­¦å‘Šæ¼”å‡ºã‚’ã‚³ãƒ³ãƒ†ãƒŠã«é©ç”¨
            if (isWarning) {
                container.classList.add('warning-shake');
                feedbackEl.style.backgroundColor = '#f7dede'; // è–„ã„èµ¤èƒŒæ™¯
            } else {
                feedbackEl.style.backgroundColor = '#e0ffe0'; // è–„ã„ç·‘èƒŒæ™¯ (å®‰å®š)
            }

            // 100mså¾Œã«UIæ›´æ–°ã¨æ•°å€¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹
            setTimeout(() => {
                // æ•°å€¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                const popEl = document.getElementById('currentPopulation');
                const moraleEl = document.getElementById('currentMorale');
                
                if (finalPop > popEl.textContent) { popEl.classList.add('flicker-good'); } 
                else if (finalPop < popEl.textContent) { popEl.classList.add('flicker-bad'); }
                
                if (currentMorale > moraleEl.textContent) { moraleEl.classList.add('flicker-good'); } 
                else if (currentMorale < moraleEl.textContent) { moraleEl.classList.add('flicker-bad'); }
                
                updateUI(); // æ•°å€¤ã‚’æ›´æ–°
                
                // 600mså¾Œã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹ã¨è­¦å‘Šæ¼”å‡ºã‚’å‰Šé™¤ã—ã€æ¬¡ã®ä¸–ä»£ã¸é€²ã‚€
                setTimeout(() => {
                    popEl.classList.remove('flicker-good', 'flicker-bad');
                    moraleEl.classList.remove('flicker-good', 'flicker-bad');
                    container.classList.remove('warning-shake');
                    feedbackEl.style.backgroundColor = '#fff8e1'; // é€šå¸¸ã®èƒŒæ™¯ã«æˆ»ã™

                    if (currentGeneration <= MAX_GENERATIONS) {
                        showDecisionScreen();
                    } else {
                        endSimulation();
                    }
                }, 600);
            }, 100);
        }

        function endSimulation() {
            document.getElementById('selectionArea').style.display = 'none';
            document.getElementById('moraleFeedback').style.display = 'none';
            document.getElementById('resultOutput').style.display = 'block';
            
            const finalPop = populationHistory[populationHistory.length - 1].length;
            const finalMorale = moraleHistory[moraleHistory.length - 1].toFixed(0);
            
            document.getElementById('finalPopulationResult').textContent = `${finalPop} äºº`;
            document.getElementById('finalPopulationResult').className = `result-final-value ${finalPop >= POPULATION_SIZE * 0.8 ? 'stat-good' : (finalPop < POPULATION_SIZE * 0.4 ? 'stat-bad' : '')}`;

            document.getElementById('finalMoraleResult').textContent = `${finalMorale}`;
            document.getElementById('finalMoraleResult').className = `result-final-value ${finalMorale >= 80 ? 'stat-good' : (finalMorale < 50 ? 'stat-bad' : '')}`;
            
            document.getElementById('famineCount').textContent = famineCounter;
            document.getElementById('techEventCount').textContent = techEventCounter;
            document.getElementById('unrestEventCount').textContent = unrestEventCounter;
            document.getElementById('climateEventCount').textContent = climateEventCounter;


            // --- åˆ†æãƒ¬ãƒãƒ¼ãƒˆã®è¨ˆç®—ã¨è¡¨ç¤º ---
            const totalGenerations = MAX_GENERATIONS;
            
            // 1. æŒ‡å°è€…åœ¨ä»»æœŸé–“ã®è¨ˆç®—
            const leaderCounts = leaderHistory.slice(0, totalGenerations).reduce((acc, leader) => {
                acc[leader] = (acc[leader] || 0) + 1;
                return acc;
            }, {});

            // 2. æ”¿ç­–é¸æŠã®åã‚Šã®è¨ˆç®—
            const choiceCounts = choiceHistory.reduce((acc, choice) => {
                acc[choice] = (acc[choice] || 0) + 1;
                return acc;
            }, {});
            
            const totalChoices = choiceHistory.length;
            const getRate = (count) => totalChoices > 0 ? ((count / totalChoices) * 100).toFixed(1) + '%' : '0%';

            // æœ€çµ‚æŒ‡å°è€…ã‚¿ã‚¤ãƒ—ã®æ•´å½¢ 
            const finalLeaderCode = leaderHistory[leaderHistory.length - 2]; 
            const finalLeaderMap = { 'H': 'æŠ€è¡“å®˜åƒš (H)', 'M': 'å‡è¡¡ä¸»ç¾©è€… (M)', 'L': 'äººé“ä¸»ç¾©è€… (L)' };

            document.getElementById('finalLeaderTypeAnalysis').textContent = finalLeaderMap[finalLeaderCode] || '--';
            document.getElementById('hLeaderCount').textContent = (leaderCounts['H'] || 0) + ' ä¸–ä»£';
            document.getElementById('mLeaderCount').textContent = (leaderCounts['M'] || 0) + ' ä¸–ä»£';
            document.getElementById('lLeaderCount').textContent = (leaderCounts['L'] || 0) + ' ä¸–ä»£';

            document.getElementById('p5ChoiceRate').textContent = getRate(choiceCounts['P5'] || 0);
            document.getElementById('p2ChoiceRate').textContent = getRate(choiceCounts['P2'] || 0);
            document.getElementById('p6ChoiceRate').textContent = getRate(choiceCounts['P6'] || 0);
        }

        // åˆæœŸè¡¨ç¤º
        showDecisionScreen();
    </script>
</body>
</html>
