<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€ä¸–è«–ã¨æ±ºæ–­ã€‘10ä¸–ä»£ã®å€«ç†ã¨ç”Ÿå­˜æˆ¦ç•¥</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: #fff;
            padding: 30px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: 12px;
        }
        h1 {
            color: #4a90e2;
            text-align: center;
            border-bottom: 3px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 25px;
        }
        .info-box {
            display: flex;
            justify-content: space-around;
            background: #e9f5ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            /* ã‚¹ãƒãƒ›ã§æ¨ªä¸¦ã³ã‚’ç¶­æŒã™ã‚‹ãŸã‚ã«flex-wrapã‚’åˆ¶å¾¡ */
            flex-wrap: wrap; 
        }
        .stat {
            text-align: center;
            /* 4é …ç›®ãŒã‚¹ãƒãƒ›ã§ç¶ºéº—ã«åã¾ã‚‹ã‚ˆã†å¹…ã‚’èª¿æ•´ */
            flex: 1 1 45%; 
            min-width: 100px;
            margin: 5px 0;
        }
        .stat-label {
            font-size: 13px;
            color: #1a56a0;
            font-weight: bold;
            margin-bottom: 3px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        .stat-good { color: #2ecc71; }
        .stat-bad { color: #e74c3c; }
        .controls {
            text-align: center;
            margin: 30px 0;
            padding: 20px;
            border: 2px dashed #a0c3e8;
            border-radius: 10px;
        }
        .controls h2 {
            color: #4a90e2;
            margin-top: 0;
            font-size: 20px;
        }
        
        /* 3ã¤ã®ãƒœã‚¿ãƒ³ãŒç¸¦ã«ä¸¦ã¶ã‚ˆã†ã«èª¿æ•´ */
        #mainSelectionButtons {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-top: 20px;
        }

        /* ãƒœã‚¿ãƒ³ã®å¹…ã‚’ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ãƒ™ãƒ¼ã‚¹ã«å¤‰æ›´ */
        button {
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: transform 0.1s, box-shadow 0.1s;
            margin: 8px 0; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ä¸Šä¸‹ã«èª¿æ•´ */
            width: 95%; 
            max-width: 380px; 
            box-shadow: 0 4px #4a4a4a;
            background-color: #f0f0f0;
            color: #333;
        }
        button:hover {
            opacity: 0.9;
        }
        button:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        #proposedPolicy {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
            padding: 10px;
            background: #e9f5ff;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .result-final-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .hidden-indicator {
            font-size: 14px;
            color: #555;
            margin-top: 15px;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }
        .hidden-indicator span {
            font-weight: bold;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ã€ä¸–è«–ã¨æ±ºæ–­ã€‘10ä¸–ä»£ã®å€«ç†ã¨ç”Ÿå­˜æˆ¦ç•¥</h1>
        <p>ã‚ãªãŸã¯æœ€é«˜æŒ‡å°è€…ã§ã™ã€‚æ¯ä¸–ä»£ã€ä¸–è«–ã®ææ¡ˆã«å¯¾ã—ã€3ã¤ã®é¸æŠè‚¢ã‹ã‚‰æ±ºæ–­ã—ã¦ãã ã•ã„ã€‚</p>
        
        <div class="info-box">
            <div class="stat">
                <div class="stat-label">ç¾åœ¨ä¸–ä»£</div>
                <div class="stat-value" id="currentGeneration">1 / 10</div>
            </div>
            <div class="stat">
                <div class="stat-label">ç”Ÿå­˜äººå£</div>
                <div class="stat-value" id="currentPopulation">1000</div>
            </div>
            <div class="stat">
                <div class="stat-label">ç¤¾ä¼šãƒ¢ãƒ©ãƒ«</div>
                <div class="stat-value" id="currentMorale">100</div>
            </div>
            <div class="stat">
                <div class="stat-label">é£Ÿç³§çŠ¶æ³ (ç”Ÿç”£/æ¶ˆè²»)</div>
                <div class="stat-value" id="currentProduction">-- / --</div>
            </div>
        </div>

        <div class="controls" id="selectionArea">
            <h2 id="controlTitle">æœ€é«˜æŒ‡å°è€…ã®æ±ºæ–­ (ç¬¬ 1 / 10)</h2>
            <p id="controlDescription">ä¸–è«–ã¯æ¬¡ã®é…åˆ†ãƒ«ãƒ¼ãƒ«ã‚’ææ¡ˆã—ã¦ã„ã¾ã™ã€‚</p>
            
            <div id="proposedPolicy">ä¸–è«–ã®ææ¡ˆã‚’ç”Ÿæˆä¸­ã§ã™...</div>

            <div id="mainSelectionButtons">
                <button id="choiceAccept" style="background-color: #2ecc71; color: white; box-shadow: 0 4px #27ae60;">
                    âœ… æ±ºå®š (ææ¡ˆé€šã‚Šã«é€²ã‚ã‚‹)
                </button>
                <button id="choiceModerate" style="background-color: #f39c12; color: white; box-shadow: 0 4px #e67e22;">
                    âš–ï¸ èª¿æ•´ (å‡è¡¡é…åˆ† P2ã‚’ä»£ã‚ã‚Šã«å®Ÿè¡Œ)
                </button>
                <button id="choiceRebel" style="background-color: #e74c3c; color: white; box-shadow: 0 4px #c0392b;">
                    âŒ åæŠ— (ä¸–è«–ã«é€†ã‚‰ã„ã€çœŸé€†ã®æ”¿ç­–ã‚’å¼·è¡Œã™ã‚‹)
                </button>
            </div>
        </div>

        <div id="resultOutput" style="display: none;">
            <h2>ğŸš¨ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº† ğŸš¨</h2>
            <p>ã‚ãªãŸã®æ±ºæ–­ãŒã‚‚ãŸã‚‰ã—ãŸ10ä¸–ä»£å¾Œã®çµæœã§ã™ã€‚</p>
            <p class="result-label">æœ€çµ‚ç”Ÿå­˜äººå£:</p>
            <span class="result-final-value" id="finalPopulationResult"></span>
            <p class="result-label">æœ€çµ‚ç¤¾ä¼šãƒ¢ãƒ©ãƒ«:</p>
            <span class="result-final-value" id="finalMoraleResult"></span>
            <p class="hidden-indicator">
                ã€éš ã‚ŒãŸæŒ‡æ¨™ã€‘<br>
                ä¸–è«–ã¨ã®æ‘©æ“¦ (åæŠ—å›æ•°): <span id="rebelCount">0</span>å› <br>
                é£¢é¤“ç™ºç”Ÿå›æ•°: <span id="famineCount">0</span>å›
            </p>
        </div>
    </div>
    
    <script>
        // --- 1. å®šæ•°ã¨åˆæœŸè¨­å®š ---
        const POPULATION_SIZE = 1000;
        const MAX_GENERATIONS = 10; 
        const CONSUMPTION_PER_PERSON = 3.5; 
        const FOOD_CRISIS_MAGNITUDE = 0.35; 
        const MORALE_LOW_THRESHOLD = 50; 
        const REBEL_MORALE_PENALTY = 10; 

        let currentGeneration = 1;
        let currentMorale = 100;
        let famineCounter = 0;
        let rebelCounter = 0;
        
        // --- 2. æ–°ã—ã„é…åˆ†ãƒ«ãƒ¼ãƒ« (4ç¨®é¡) ---
        const DISTRIBUTION_POLICIES = [
            { id: 'P1', label: 'ç”Ÿç”£æ€§çµ¶å¯¾å„ªå…ˆ (é«˜ç”Ÿç”£åšé‡)', boost: 0.15, morale_impact: -10, description: 'é«˜ç”Ÿç”£è€…ã«é‡ç‚¹é…åˆ†ã€‚æœ€å¤§åŠ¹ç‡ã‚’è¿½æ±‚ã—ã¾ã™ã€‚' },
            { id: 'P2', label: 'å‡è¡¡é…åˆ† (å…¨å“¡å‡ç­‰)', boost: 0.05, morale_impact: 0, description: 'å…¨ã‚°ãƒ«ãƒ¼ãƒ—ã«å‡ç­‰é…åˆ†ã€‚å®‰å®šã—ãŸæˆé•·ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚' },
            { id: 'P3', label: 'å¼±è€…å„ªå…ˆ (ç„¡ç”Ÿç”£åšé‡)', boost: -0.05, morale_impact: 15, description: 'ç„¡ç”Ÿç”£è€…ã‚’ä¿è­·ã€‚ãƒ¢ãƒ©ãƒ«ã‚’é‡è¦–ã—ã¾ã™ã€‚' },
            { id: 'P4', label: 'èª¿æ•´å‹ (é«˜ç”Ÿç”£æ™®é€š, ç„¡ç”Ÿç”£å¤šã‚)', boost: 0.0, morale_impact: 5, description: 'é«˜ç”Ÿç”£è€…ã¨å¼±è€…ã®é–“ã§åˆ©ç›Šã‚’èª¿æ•´ã—ã¾ã™ã€‚' }
        ];

        // --- 3. å›½æ°‘åˆ†é¡ã®é–¢æ•° ---
        function classifyPopulation(population) {
            const producers = population.filter(p => p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£');
            
            producers.sort((a, b) => b.production - a.production);
            const highProdCount = Math.ceil(producers.length * 0.4);
            
            let classified = {
                high_prod: [],
                mid_prod: [],
                non_prod: population.filter(p => p.group !== 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£')
            };

            producers.forEach((p, index) => {
                p.category = (index < highProdCount) ? 'é«˜ç”Ÿç”£' : 'ä¸­ç”Ÿç”£';
                if (index < highProdCount) {
                    classified.high_prod.push(p);
                } else {
                    classified.mid_prod.push(p);
                }
            });

            return classified;
        }

        // --- 4. ä¸–è«–ææ¡ˆãƒ­ã‚¸ãƒƒã‚¯ ---
        function generateProposal(moraleScore, currentPop, classifiedPop) {
            const highProdRatio = classifiedPop.high_prod.length / currentPop.length;
            const nonProdRatio = classifiedPop.non_prod.length / currentPop.length;

            let moraleInfluence = (moraleScore / 100) * 0.5;
            let needInfluence = 0;

            const foodLastGen = foodHistory[foodHistory.length - 1] || 1;
            const consumptionLastGen = consumptionHistory[consumptionHistory.length - 1] || 1;
            
            if (foodLastGen < consumptionLastGen * 1.05) {
                needInfluence = Math.min(0.5, 1 - (foodLastGen / (consumptionLastGen * 1.05)));
            }

            const publicOpinionScore = (highProdRatio * 0.3) + needInfluence - (moraleInfluence * 0.5);

            let proposedPolicyId;

            if (publicOpinionScore > 0.4) {
                proposedPolicyId = 'P1'; 
            } else if (publicOpinionScore < -0.2) {
                proposedPolicyId = 'P3';
            } else if (publicOpinionScore > 0.1) {
                proposedPolicyId = 'P4';
            } else {
                proposedPolicyId = 'P2';
            }

            return DISTRIBUTION_POLICIES.find(p => p.id === proposedPolicyId);
        }

        // --- 5. ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ (å¤‰æ›´ãªã—) ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function generatePopulationData(size) {
            const data = [];
            const AGE_GROUPS = {
                'child': [0, 15, 0.20], 
                'producer': [16, 65, 0.60], 
                'elder': [66, 90, 0.20]
            };
            
            let ages = [];
            for (const group in AGE_GROUPS) {
                const [start, end, ratio] = AGE_GROUPS[group];
                const count = Math.floor(size * ratio);
                for(let i=0; i<count; i++) {
                    ages.push(Math.floor(Math.random() * (end - start + 1)) + start);
                }
            }
            ages = ages.slice(0, size);
            ages.sort(() => Math.random() - 0.5);

            for (let i = 0; i < ages.length; i++) {
                const age = ages[i];
                let group_name, occupation, production_score, past_contribution, health_status;

                if (age <= 15) {
                    group_name = 'ğŸ‘¶ å­ä¾›';
                    occupation = 'ç„¡è·/å­¦ç”Ÿ';
                    production_score = 0;
                    past_contribution = 0;
                } else if (age >= 66) {
                    group_name = 'ğŸ§“ é«˜é½¢è€…';
                    occupation = 'å¼•é€€æ¸ˆã¿';
                    production_score = 0;
                    past_contribution = Math.floor(Math.random() * 41) + 10 + (age - 66) * 2; 
                } else {
                    group_name = 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£';
                    const occupations = ['é£Ÿç³§ç”Ÿç”£è€…', 'æŠ€è¡“é–‹ç™ºè€…', 'ä¸€èˆ¬åŠ´åƒè€…', 'ã‚µãƒ¼ãƒ“ã‚¹æ¥­'];
                    occupation = occupations[Math.floor(Math.random() * occupations.length)];
                    
                    if (occupation === 'é£Ÿç³§ç”Ÿç”£è€…') {
                        production_score = Math.floor(Math.random() * 6) + 5;
                    } else if (occupation === 'æŠ€è¡“é–‹ç™ºè€…') {
                        production_score = (Math.floor(Math.random() * 6) + 3) * 1.5;
                    } else {
                        production_score = Math.floor(Math.random() * 6) + 1;
                    }
                    past_contribution = production_score * 5 + Math.floor(Math.random() * 11);
                }

                health_status = ['å¥åº·', 'è»½åº¦ã®ç—…', 'é‡åº¦ã®ç—…'][Math.floor(Math.random() * 3)];
                
                data.push({
                    id: i + 1,
                    age: age,
                    group: group_name,
                    production: production_score,
                    contribution: past_contribution,
                    health: health_status
                });
            }
            return data;
        }

        // --- 6. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ã‚¢é–¢æ•° (runGeneration) ---
        function runGeneration(currentPop, selectedPolicy) {
            let nextPop = JSON.parse(JSON.stringify(currentPop));
            let techLevel = techHistory[techHistory.length - 1];
            let moraleScore = moraleHistory[moraleHistory.length - 1];
            
            const classifiedPop = classifyPopulation(nextPop);

            // --- 6A. ç”Ÿç”£é‡è¨ˆç®— ---
            const totalConsumptionNeed = nextPop.length * CONSUMPTION_PER_PERSON;
            
            let moralePenaltyFactor = 1.0;
            if (moraleScore < MORALE_LOW_THRESHOLD) {
                moralePenaltyFactor = 1.0 - (Math.random() * 0.15); 
                famineCounter++;
            }

            const prodBoost = selectedPolicy.boost;
            
            const totalProductionScore = nextPop.reduce((sum, p) => {
                let currentProd = p.production;
                if (p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£') {
                    if (p.category === 'é«˜ç”Ÿç”£') {
                        currentProd *= (1 + prodBoost);
                    }
                }
                return sum + currentProd;
            }, 0);

            const foodProduced = totalProductionScore * techLevel * FOOD_CRISIS_MAGNITUDE * moralePenaltyFactor;
            
            // --- 6B. ç”Ÿå­˜åˆ¤å®š ---
            let survivors = [];

            if (foodProduced < totalConsumptionNeed) {
                
                nextPop.forEach(p => {
                    let priority = 0;
                    
                    if (selectedPolicy.id === 'P1') { 
                        priority = (p.category === 'é«˜ç”Ÿç”£' ? 100 : (p.category === 'ä¸­ç”Ÿç”£' ? 50 : 10));
                    } else if (selectedPolicy.id === 'P3') { 
                        priority = (p.group === 'ğŸ§“ é«˜é½¢è€…' || p.group === 'ğŸ‘¶ å­ä¾›' ? 100 : 50);
                    } else { 
                        priority = (p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£' ? 70 : 50);
                    }
                    
                    priority += p.production * 5 + p.contribution * 0.5;

                    p.priority = priority;
                });

                nextPop.sort((a, b) => b.priority - a.priority);
                const survivorCount = Math.floor(foodProduced / CONSUMPTION_PER_PERSON);
                survivors = nextPop.slice(0, survivorCount);
                
            } else {
                survivors = nextPop;
            }
            
            if (survivors.length === 0) {
                 return { nextPop: [], nextTech: techLevel, nextMorale: 0, food: foodProduced, consumption: totalConsumptionNeed };
            }

            const initialElderCount = nextPop.filter(p => p.group === 'ğŸ§“ é«˜é½¢è€…').length;
            const elderSurvivorsCount = survivors.filter(p => p.group === 'ğŸ§“ é«˜é½¢è€…').length;
            const elderSurvivalRate = initialElderCount > 0 ? elderSurvivorsCount / initialElderCount : 0;


            // --- 6C. ãƒ¢ãƒ©ãƒ«å¤‰å‹•ã®è¨ˆç®— ---
            let deltaMorale = 0;
            
            deltaMorale += selectedPolicy.morale_impact;

            if (elderSurvivalRate < 0.1 && initialElderCount > 0) {
                deltaMorale -= 10; 
            } else if (elderSurvivalRate > 0.8 && initialElderCount > 0) {
                deltaMorale += 5;
            }

            if (foodProduced >= totalConsumptionNeed * 1.25) {
                deltaMorale += 7; 
            } else if (foodProduced < totalConsumptionNeed * 0.8) {
                deltaMorale -= 7; 
            }

            moraleScore = Math.min(100, Math.max(0, moraleScore + deltaMorale));
            
            // --- 6D. ä¸–ä»£äº¤ä»£ã¨æŠ€è¡“æ›´æ–° ---
            
            const survivorProducerScore = survivors.filter(p => p.group === 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£').reduce((sum, p) => sum + p.production, 0);
            let techBoost = totalProductionScore > 0 ? survivorProducerScore / totalProductionScore : 0;
            
            techLevel *= (1 + techBoost * 0.1) * (moraleScore / 100); 
            
            let nextGenPop = survivors.filter(p => p.age < 90).map(p => ({
                ...p,
                age: p.age + 1,
                group: (p.age + 1 >= 66) ? 'ğŸ§“ é«˜é½¢è€…' : (p.age + 1 <= 15 ? 'ğŸ‘¶ å­ä¾›' : 'ğŸ§‘ ç”Ÿç”£ä¸–ä»£')
            }));
            
            const nextGenCount = Math.floor(survivors.length * 0.15);
            const newBabies = generatePopulationData(nextGenCount).filter(p => p.group === 'ğŸ‘¶ å­ä¾›');
            
            nextPop = nextGenPop.concat(newBabies);
            
            return { nextPop: nextPop, nextTech: techLevel, nextMorale: moraleScore, food: foodProduced, consumption: totalConsumptionNeed };
        }

        // --- 7. ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã¨UIåˆ¶å¾¡ ---
        const initialPopulationData = generatePopulationData(POPULATION_SIZE);
        let populationHistory = [initialPopulationData];
        let techHistory = [1.0];
        let moraleHistory = [100];
        let foodHistory = [];
        let consumptionHistory = [];
        let proposedPolicy = null;

        function updateUI() {
            const currentPopData = populationHistory[populationHistory.length - 1];
            const currentFood = foodHistory[foodHistory.length - 1] || 0; 
            const currentConsumption = consumptionHistory[consumptionHistory.length - 1] || 0;

            document.getElementById('currentGeneration').textContent = `${currentGeneration} / ${MAX_GENERATIONS}`;
            document.getElementById('currentPopulation').textContent = currentPopData.length;
            document.getElementById('currentMorale').textContent = currentMorale.toFixed(0);
            document.getElementById('currentMorale').className = `stat-value ${currentMorale > 80 ? 'stat-good' : (currentMorale < 50 ? 'stat-bad' : '')}`;
            
            document.getElementById('currentProduction').textContent = (currentGeneration > 1) ? `${currentFood.toFixed(0)} / ${currentConsumption.toFixed(0)}` : '-- / --';
        }

        function showDecisionScreen() {
            if (currentGeneration > MAX_GENERATIONS || populationHistory[populationHistory.length - 1].length === 0) {
                endSimulation();
                return;
            }

            const currentPopData = populationHistory[populationHistory.length - 1];
            const classifiedPop = classifyPopulation(currentPopData);
            
            // ä¸–è«–ã«ã‚ˆã‚‹ææ¡ˆ
            proposedPolicy = generateProposal(currentMorale, currentPopData, classifiedPop);

            document.getElementById('controlTitle').textContent = `æœ€é«˜æŒ‡å°è€…ã®æ±ºæ–­ (ç¬¬ ${currentGeneration} / ${MAX_GENERATIONS})`;
            document.getElementById('controlDescription').innerHTML = 'ä¸–è«–ã¯æ¬¡ã®**1ä¸–ä»£**ã®é…åˆ†ãƒ«ãƒ¼ãƒ«ã‚’ææ¡ˆã—ã¦ã„ã¾ã™ã€‚';
            
            // â˜…â˜…â˜… ææ¡ˆè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ (æœ€çµ‚å®‰å®šç‰ˆ) â˜…â˜…â˜…
            let proposalHtml;
            if (proposedPolicy) {
                proposalHtml = `ææ¡ˆãƒ«ãƒ¼ãƒ«: **${proposedPolicy.label}**<br><span style="font-size:0.8em; color: #555
